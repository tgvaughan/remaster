<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-04-08 Mon 16:58 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ReMASTER</title>
<meta name="author" content="Tim Vaughan" />
<meta name="generator" content="Org Mode" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="css/readtheorg.css"/>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="css/katex.min.css" />
<script defer type="text/javascript" src="js/katex.min.js"></script>
<script defer type="text/javascript" src="js/katex-auto-render.min.js"></script>
<script> document.addEventListener("DOMContentLoaded", function() {renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}], throwOnError : false});}); </script>
<link rel="stylesheet" type="text/css" href="css/syntaxhl.css" />
<style>h1.title {display:none}</style>
</head>
<body>
<div id="content" class="content">
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#id-1-Overview">1. Overview</a>
<ul>
<li><a href="#id-2-Overview-The-name">1.1. The name</a></li>
<li><a href="#id-2-Overview-License">1.2. License</a></li>
<li><a href="#id-2-Overview-Citing-ReMASTER">1.3. Citing ReMASTER</a></li>
</ul>
</li>
<li><a href="#id-1-Installation">2. Installation</a></li>
<li><a href="#id-1-Using-ReMASTER:-General-overview">3. Using ReMASTER: General overview</a>
<ul>
<li><a href="#id-2-Using-ReMASTER:-General-overview-How-to-read-this-manual">3.1. How to read this manual</a></li>
</ul>
</li>
<li><a href="#id-1-Birth-death-simulations">4. Birth-death simulations</a>
<ul>
<li><a href="#id-2-Birth-death-simulations-Model-specification">4.1. Model specification</a>
<ul>
<li><a href="#id-3-Model-specification-Birth-death-simulations-Populations">4.1.1. Populations</a></li>
<li><a href="#id-3-Model-specification-Birth-death-simulations-Reactions">4.1.2. Reactions</a>
<ul>
<li><a href="#id-4-Reactions-Model-specification-Birth-death-simulations-Continuous-reactions">4.1.2.1. Continuous reactions</a></li>
<li><a href="#id-4-Reactions-Model-specification-Birth-death-simulations-Punctual-reactions">4.1.2.2. Punctual reactions</a></li>
<li><a href="#id-4-Reactions-Model-specification-Birth-death-simulations-Identifying-parents-and-children">4.1.2.3. Identifying parents and children</a></li>
</ul>
</li>
<li><a href="#id-3-Model-specification-Birth-death-simulations-Complex-model-configurations-using-plates">4.1.3. Complex model configurations using plates</a></li>
</ul>
</li>
<li><a href="#id-2-Birth-death-simulations-Trajectory-simulation">4.2. Trajectory simulation</a>
<ul>
<li><a href="#id-3-Trajectory-simulation-Birth-death-simulations-Stochastic-Trajectories">4.2.1. Stochastic Trajectories</a></li>
<li><a href="#id-3-Trajectory-simulation-Birth-death-simulations-Deterministic-Trajectories">4.2.2. Deterministic Trajectories</a></li>
<li><a href="#id-3-Trajectory-simulation-Birth-death-simulations-Placing-conditions-on-trajectories">4.2.3. Placing conditions on trajectories</a></li>
<li><a href="#id-3-Trajectory-simulation-Birth-death-simulations-Self-contained-trajectory-simulation-XMLs">4.2.4. Self-contained trajectory simulation XMLs</a></li>
<li><a href="#id-3-Trajectory-simulation-Birth-death-simulations-Plotting-simulated-trajectories">4.2.5. Plotting simulated trajectories</a></li>
<li><a href="#id-3-Trajectory-simulation-Birth-death-simulations-Logging-stochastic-trajectory-statistics">4.2.6. Logging stochastic trajectory statistics</a></li>
</ul>
</li>
<li><a href="#id-2-Birth-death-simulations-Tree-simulation">4.3. Tree simulation</a>
<ul>
<li><a href="#id-3-Tree-simulation-Birth-death-simulations-Self-contained-tree-simulation-XMLs">4.3.1. Self-contained tree simulation XMLs</a></li>
<li><a href="#id-3-Tree-simulation-Birth-death-simulations-Logging-typed-trees">4.3.2. Logging typed trees</a></li>
<li><a href="#id-3-Tree-simulation-Birth-death-simulations-Logging-untyped-trees">4.3.3. Logging untyped trees</a></li>
<li><a href="#id-3-Tree-simulation-Birth-death-simulations-Logging-trees-with-variable-numbers-of-leaves">4.3.4. Logging trees with variable numbers of leaves</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#id-1-Coalescent-simulations">5. Coalescent simulations</a>
<ul>
<li><a href="#id-2-Coalescent-simulations-Model-specification">5.1. Model specification</a>
<ul>
<li><a href="#id-3-Model-specification-Coalescent-simulations-Vector-valued-coalescent-Reaction-inputs">5.1.1. Vector-valued coalescent Reaction inputs</a></li>
<li><a href="#id-3-Model-specification-Coalescent-simulations-Parents-and-children-in-coalescent-reactions">5.1.2. Parents and children in coalescent reactions</a></li>
</ul>
</li>
<li><a href="#id-2-Coalescent-simulations-Trajectory-simulation">5.2. Trajectory simulation</a></li>
<li><a href="#id-2-Coalescent-simulations-Tree-simulation">5.3. Tree simulation</a></li>
<li><a href="#id-2-Coalescent-simulations-More-complex-coalescent-models">5.4. More complex coalescent models</a></li>
</ul>
</li>
<li><a href="#id-1-Integrating-with-BEAST">6. Integrating with BEAST</a></li>
<li><a href="#id-1-Examples">7. Examples</a></li>
<li><a href="#id-1-Appendix">8. Appendix</a>
<ul>
<li><a href="#id-2-Appendix-Condition-syntax">8.1. Condition syntax</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<figure id="org979a96d">
<img src="logos/remaster_logo.svg" alt="remaster_logo.svg" class="org-svg">

</figure>

<p>
<p class="subtitle" role="doc-subtitle">High-fidelity stochastic tree simulation for BEAST 2</p>
</p>

<p>
GitHub Repository: <a href="https://github.com/tgvaughan/remaster">https://github.com/tgvaughan/remaster</a>
</p>

<div id="outline-container-id-1-Overview" class="outline-2">
<h2 id="id-1-Overview"><span class="section-number-2">1.</span> Overview</h2>
<div class="outline-text-2" id="text-id-1-Overview">
<p>
ReMASTER is a flexible tool for simulating trajectories
and trees from the birth-death and coalescent models commonly employed in
phylodynamic inference, as well as some less common models.
</p>

<p>
ReMASTER defines birth-death population models using an intuitive
"reaction" notation borrowed from chemistry.  Using this notation,
a simple birth-death process on the number of individuals of type $X$
might be expressed using the following pair of reactions:
$$X \overset{\lambda}{\longrightarrow} 2X$$
and
$$X \overset{\mu}{\longrightarrow} 0$$
where in each case the elements on the left-hand side of the arrow
indicate the individual(s) involved in the reaction (the reactants),
and the elements on the right-hand side correspond to the individual(s)
remaining after the reaction has fired.  The symbol above the arrow
represents the rate (probability per unit time) at which the reaction
fires for each available combination of reactants.
</p>

<p>
In order to permit the simulation of reconstructed phylogenies corresponding
to subsets of the whole population, ReMASTER allows users to specify that
one or more of the model populations are "sample" populations.  This means
that sampling processes can be explicitly included in the simulation model.
For instance, by adding the reaction
$$ X \overset{\psi}{\longrightarrow} S$$
where $S$ is defined as a sample population, the birth-death model above becomes the
linear birth-death-sampling model which is the basis of much modern phylodynamic inference.
</p>

<p>
In addition, ReMASTER allows one to define "punctual" reactions which occur
at pre-determined times and fire a fixed or stochastic number of times.
Besides allowing models to include interesting discrete events, this allows
users to pre-specify sample counts and times.
</p>

<p>
Setting up a birth-death model in ReMASTER involves composing an XML input file
describing initial population sizes and the set of reactions governing
their dynamics.  The input file format is quite readable and concise.
For example, the following is a complete XML input file for 
simulating 100 trees under a the above birth-death sampling model with
$\lambda=2$, $\mu=1$ and $\psi=0.1$:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">beast</span> <span class="org-nxml-attribute-local-name">version</span>=<span class="org-string">"2.0"</span> <span class="org-nxml-attribute-local-name">namespace</span>=<span class="org-string">"beast.base.inference:beast.base.inference.parameter:remaster"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">run</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Simulator"</span> <span class="org-nxml-attribute-local-name">nSims</span>=<span class="org-string">"100"</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">simulate</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"SimulatedTree"</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"tree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
            <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectory"</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"SIRTrajectory"</span> <span class="org-nxml-attribute-local-name">endsWhen</span>=<span class="org-string">"S&gt;=10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
                <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
                <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">samplePopulation</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"S"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

                <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"2"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 2X </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
                <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 0 </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
                <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; S </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
            <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">simulate</span><span class="org-nxml-tag-delimiter">&gt;</span>

        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Logger"</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"simulated.trees"</span><span class="org-nxml-tag-delimiter">&gt;</span>
            <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">idref</span>=<span class="org-string">"tree"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">run</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">beast</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
For coalescent tree simulation, ReMASTER uses a similar approach to model
specification but relies on BEAST 2 <code>PopulationFunction</code> objects (such as
<code>ConstantPopulation</code> and <code>ExponentialGrowth</code>) to condition on population
dynamics, together with reactions which are directly applied to coalescent
tree lineages as they evolve backward in time.
</p>

<p>
ReMASTER is a <a href="https://www.beast2.org/">BEAST 2</a> package, and integrates well with that platform.
Simulated ReMASTER trees can be used directly inside of regular BEAST
XML analysis scripts to initialise MCMC states or construct
simulation-based validation studies.
</p>
</div>

<div id="outline-container-id-2-Overview-The-name" class="outline-3">
<h3 id="id-2-Overview-The-name"><span class="section-number-3">1.1.</span> The name</h3>
<div class="outline-text-3" id="text-id-2-Overview-The-name">
<p>
"ReMASTER" is a play on the name of an earlier simulation tool,
<a href="https://tgvaughan.github.io/MASTER">MASTER</a>.  ReMASTER is a completely new implementation which is faster,
leaner, and more capable of performing the simulation tasks for which
MASTER itself was actually used.
</p>
</div>
</div>

<div id="outline-container-id-2-Overview-License" class="outline-3">
<h3 id="id-2-Overview-License"><span class="section-number-3">1.2.</span> License</h3>
<div class="outline-text-3" id="text-id-2-Overview-License">
<p>
ReMASTER is free software, and is made available under the terms of
version 3 of the GNU General Public License, the text of which is
available <a href="https://raw.githubusercontent.com/tgvaughan/remaster/master/COPYING">here</a>.  The source code for the project can be found at the
official GitHub project page: <a href="https://github.com/tgvaughan/remaster">https://github.com/tgvaughan/remaster</a>.
</p>
</div>
</div>

<div id="outline-container-id-2-Overview-Citing-ReMASTER" class="outline-3">
<h3 id="id-2-Overview-Citing-ReMASTER"><span class="section-number-3">1.3.</span> Citing ReMASTER</h3>
<div class="outline-text-3" id="text-id-2-Overview-Citing-ReMASTER">
<p>
If you use ReMASTER as part of research that leads to a publication,
please cite the following article:
</p>

<blockquote>
<p>
T. G. Vaughan, "ReMASTER: Improved phylodynamic simulation for BEAST 2.7",
Bioinformatics, btae015, 2024. (<a href="https://doi.org/10.1093/bioinformatics/btae015">https://doi.org/10.1093/bioinformatics/btae015</a>)
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-id-1-Installation" class="outline-2">
<h2 id="id-1-Installation"><span class="section-number-2">2.</span> Installation</h2>
<div class="outline-text-2" id="text-id-1-Installation">
<p>
ReMASTER is a BEAST 2 package.  To install it, you'll first need to ensure a
recent version of BEAST 2 (version 2.7 or later) is available on your system.
If not, go to <a href="https://beast2.org">https://beast2.org</a> and follow the instructions.
</p>

<p>
Once BEAST 2 is installed, ReMASTER can be installed directly from the
standard BEAST 2 package repository.  To do this, follow these steps:
</p>

<ol class="org-ol">
<li>Open BEAUti,</li>
<li>Open the <code>File</code> menu and select <code>Manage packages</code>.</li>
<li>Select "ReMASTER" from the package list and press the
<code>Install/Upgrade</code> button.</li>
</ol>


<figure id="org099c1af">
<img src="figures/install.png" alt="install.png">

</figure>

<p>
The ReMASTER package should now be available on your system!
</p>
</div>
</div>

<div id="outline-container-id-1-Using-ReMASTER:-General-overview" class="outline-2">
<h2 id="id-1-Using-ReMASTER:-General-overview"><span class="section-number-2">3.</span> Using ReMASTER: General overview</h2>
<div class="outline-text-2" id="text-id-1-Using-ReMASTER:-General-overview">
<p>
As mentioned in the <a href="#id-1-Overview">overview</a> above, the general approach to using
ReMASTER is involves (1) model conception, (2) XML input file
creation, (3) running BEAST 2 (and hence, ReMASTER) on this input
file, and (4) visualising or post-processing the generated output
files. This workflow is summarized in the following figure:
</p>

<p>
<img src="figures/usage.svg" alt="usage.svg" class="org-svg">
 <br>
</p>

<p>
The following sections will guide you through the process of defining
birth-death and coalescent phylodynamic models, setting up the XML
input files which describe them, as well as running the simulations and
analysing the results of birth-death and coalescent simulations.
</p>
</div>

<div id="outline-container-id-2-Using-ReMASTER:-General-overview-How-to-read-this-manual" class="outline-3">
<h3 id="id-2-Using-ReMASTER:-General-overview-How-to-read-this-manual"><span class="section-number-3">3.1.</span> How to read this manual</h3>
<div class="outline-text-3" id="text-id-2-Using-ReMASTER:-General-overview-How-to-read-this-manual">
<p>
While it is organised in a structured way, this manual is designed to
be read directly from start to finish.  Thus, even if you are only
interested in coalescent simulation, please read the <a href="#id-1-Birth-death-simulations">Birth-death
simulations</a> chapter first&#x2014;it introduces in detail several key
concepts shared by all simulation types.
</p>
</div>
</div>
</div>


<div id="outline-container-id-1-Birth-death-simulations" class="outline-2">
<h2 id="id-1-Birth-death-simulations"><span class="section-number-2">4.</span> Birth-death simulations</h2>
<div class="outline-text-2" id="text-id-1-Birth-death-simulations">
<p>
Birth-death simulations are the bread and butter of ReMASTER.  Unlike
MASTER, ReMASTER is built from the ground up to make simulating
birth-death trajectories and trees as easy and flexible as possible.
</p>
</div>

<div id="outline-container-id-2-Birth-death-simulations-Model-specification" class="outline-3">
<h3 id="id-2-Birth-death-simulations-Model-specification"><span class="section-number-3">4.1.</span> Model specification</h3>
<div class="outline-text-3" id="text-id-2-Birth-death-simulations-Model-specification">
<p>
Like MASTER, ReMASTER defines models in terms of <a href="#id-3-Model-specification-Birth-death-simulations-Populations">populations</a> and <a href="#id-3-Model-specification-Birth-death-simulations-Reactions">reactions</a>.
</p>
</div>

<div id="outline-container-id-3-Model-specification-Birth-death-simulations-Populations" class="outline-4">
<h4 id="id-3-Model-specification-Birth-death-simulations-Populations"><span class="section-number-4">4.1.1.</span> Populations</h4>
<div class="outline-text-4" id="text-id-3-Model-specification-Birth-death-simulations-Populations">
<p>
A population in ReMASTER is simply a <code>RealParameter</code> (or other
<code>Function</code>) with a specific ID.  The value of the <code>RealParameter</code> is
used as its initial population size in the simulation.
</p>

<p>
For example, the following defines a population named "X" with an initial size
of 10:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
If the <code>RealParameter</code> is a vector, its elements represent subpopulations.
For example, the following population "Y" has two subpopulations initially
occupied by 1 and 10 individuals, respectively:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"Y"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1 10"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
Populations may also be marked as "sample" populations by using the appropriate
tag:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">samplePopulation</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"sample"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
For trajectories, sample populations behave just like any other
population, besides being forbidden from appearing on the reactant
side of a reaction.  individuals of these populations take on a
special meaning when trees are simulated, however, as the production
of a sample corresponds to the creation of a node (internal or
external) in the resulting tree.
</p>
</div>
</div>

<div id="outline-container-id-3-Model-specification-Birth-death-simulations-Reactions" class="outline-4">
<h4 id="id-3-Model-specification-Birth-death-simulations-Reactions"><span class="section-number-4">4.1.2.</span> Reactions</h4>
<div class="outline-text-4" id="text-id-3-Model-specification-Birth-death-simulations-Reactions">
<p>
Reactions connect zero or more <b>reactant</b> individuals with zero or
more <b>product</b> individuals.  The dynamics that ReMASTER simulates are
simply the result of applying reactions at random or pre-determined times.
</p>

<p>
There are two distinct kinds of reactions which can be specified: "continuous"
reactions and "punctual" reactions.
</p>
</div>

<div id="outline-container-id-4-Reactions-Model-specification-Birth-death-simulations-Continuous-reactions" class="outline-5">
<h5 id="id-4-Reactions-Model-specification-Birth-death-simulations-Continuous-reactions"><span class="section-number-5">4.1.2.1.</span> Continuous reactions</h5>
<div class="outline-text-5" id="text-id-4-Reactions-Model-specification-Birth-death-simulations-Continuous-reactions">
<p>
As the name suggests, these reactions are applied continuously throughout the
simulation at particular <i>rates</i> which, together with the current state
of tye system, determine the reaction probability per
unit time for the reaction firing on each of the possible <i>combinations</i>
of reactant individuals.
</p>

<p>
More specifically, a reaction with rate $\lambda$ is related to the overall reaction propensity
$\Lambda$ via the following equation:
$$\Lambda = \lambda \prod_{i}\binom{N_i}{n_i}$$
where $i$ ranges over all reactant types, $N_i$ represents the total
number of individuals of type $i$, and $n_i$ represents the number of reactants
of type $i$ required for the reaction.
</p>

<p>
<b><b>For users of MASTER</b></b>: The relationship between rates and
propensities is subtly different in ReMASTER compared to MASTER.  In
MASTER, rates were expressed per <i>ordered sequence</i> of reactants,
rather than per <i>combination</i> of reactants.  This earlier choice was made for
historical reasons, but the relationship above is arguably much more
sensible.  However, this change means that, for reactions involving
more than one reactant of a given type, the MASTER reaction rate
constants must be multiplied by a factor of $1/n_i!$ for each type $i$
in order to produce exactly the same results as ReMASTER.
</p>

<p>
Use the following notation to specify a continuous reaction with a
fixed rate (per reactant configuration) in the XML:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"2"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> S + I -&gt; 2I </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
This reaction takes one $S$ individual and one $I$ individual and replaces them with two
individuals of population $I$, and occurs with rate 2 between every compatible pair of
individuals.  That is, the overall rate at which the reaction occurs in the whole
population is
$$ (\text{number of $S$ and $I$ pairs}) \times 2 = 2N_SN_I $$
per unit time.
</p>


<p>
The per-configuration rate of a continuous reaction can change at one
or more times.  For example, to specify that the rate should change
from 2 to 1.4 at time 4, you can write the following:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"2 1.4"</span> <span class="org-nxml-attribute-local-name">changeTimes</span>=<span class="org-string">"4"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> S + I -&gt; 2I </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
For reactions involving populations with multiple subpopulations,
members of those subpopulations can be referenced using square bracket
notation.  For instance, a birth reaction specific to one of the two
subpopulations of population $Y$ defined in the last section could be
written:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.5"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> Y[0] -&gt; Y[0] + Y[1] </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-id-4-Reactions-Model-specification-Birth-death-simulations-Punctual-reactions" class="outline-5">
<h5 id="id-4-Reactions-Model-specification-Birth-death-simulations-Punctual-reactions"><span class="section-number-5">4.1.2.2.</span> Punctual reactions</h5>
<div class="outline-text-5" id="text-id-4-Reactions-Model-specification-Birth-death-simulations-Punctual-reactions">
<p>
In contrast, punctual reactions are applied at one or more pre-defined
<i>times</i>. At each of these times, a punctual reaction may be applied
with some probability to each available combination of reactants
(i.e. the number of times the reaction fires is still random) or it
may be applied a pre-specified number of times.
</p>

<p>
To specify a punctual reaction which fires with a particular probability
for each available reactant (here 0.5) and at a chosen time (here 10),
use the following notation:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">p</span>=<span class="org-string">"0.5"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> I -&gt; sample </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
To instead configure the reaction to fire a fixed number of times (say
5), replace the <code>p</code> attribute with a <code>n</code> attribute specifying the
number:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"5"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> I -&gt; sample </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
Each of <code>p</code>, <code>n</code> and <code>times</code> can take more than one value. For instance,
to specify that the sampling reaction should fire 5 times at time 1.0,
7 times at time 2.0 and 10 times at time 5.0, one could write
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"5 7 10"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"1.0 2.0 5.0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> I -&gt; sample </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
In the case that the number of elements provided to <code>n</code> or <code>p</code> and the
number provided to <code>time</code> do not match, elements of the shorter vector
are reused.  Thus one could specify multiple $&rho;$-sampling events
each with the same sampling probability of $\rho=0.5$ by writing
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">p</span>=<span class="org-string">"0.5"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"1.0 2.0 5.0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> I -&gt; sample </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-id-4-Reactions-Model-specification-Birth-death-simulations-Identifying-parents-and-children" class="outline-5">
<h5 id="id-4-Reactions-Model-specification-Birth-death-simulations-Identifying-parents-and-children"><span class="section-number-5">4.1.2.3.</span> Identifying parents and children</h5>
<div class="outline-text-5" id="text-id-4-Reactions-Model-specification-Birth-death-simulations-Identifying-parents-and-children">
<p>
Although the reaction notation is intuitive, on its own it does not
specify the parent/child relationships between reactants and products.
For example, consider the following reaction representing pathogen
transmission in an SIR model:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> S + I -&gt; 2I </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
The only thing which can be determined from this reaction is that one $S$
and one $I$ individual are replaced by a pair of $I$ individuals.  It is
completely unclear whether either of the $S$ or $I$ reactants should be
regarded as a parent of any of the products.
</p>

<p>
Specifying these relationships is necessary in order for trees composed
of ancestral lineages can be built.
</p>

<p>
There are two main ways to work around this limitation.  Firstly, one can
rely on ReMASTER to automatically associate parents with children.
By default, ReMASTER assumes that a product individual is considered to
be
</p>
<ol class="org-ol">
<li>the child of the first reactant having the same population type, if one exists, or</li>
<li>the child the first reactant listed, if one exists, or</li>
<li>an orphan.</li>
</ol>

<p>
These rules mean that, in the SIR reaction above, the two $I$ product individuals
would be regarded as children of the $I$ reactant, and that the $S$ would have no
children.
</p>

<p>
Alternatively, ReMASTER lets you explicitly specify parent-child relationships
by appending ":label" tags to reaction elements identifying them as belonging
to the same family.  If, for instance, we wanted the $S$ reactant to be the parent
of the two $I$ products, we could write
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> S:a + I:b -&gt; 2I:a </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
Note that unlike MASTER, ReMASTER requires each child have at most one parent, ensuring
that the resulting relationships are tree-like.
</p>
</div>
</div>
</div>

<div id="outline-container-id-3-Model-specification-Birth-death-simulations-Complex-model-configurations-using-plates" class="outline-4">
<h4 id="id-3-Model-specification-Birth-death-simulations-Complex-model-configurations-using-plates"><span class="section-number-4">4.1.3.</span> Complex model configurations using plates</h4>
<div class="outline-text-4" id="text-id-3-Model-specification-Birth-death-simulations-Complex-model-configurations-using-plates">
<p>
By composing populations and reactions as defined above you can construct birth-death
(and later coalescent) models of very large complexity. However, for models having
many distinct types, explicitly describing every possible reaction between these types
can become extremely tedious.
</p>

<p>
For instance, consider a model composed of 5 populations X,Y,Z,W, and V, in which
every population has initially 1 individual and each is subject to a
birth reaction.
</p>

<p>
To set this up directly would involve something like the following:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"Y"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"Z"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"W"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"V"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 2X </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> Y -&gt; 2Y </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> Z -&gt; 2Z </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> W -&gt; 2W </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> V -&gt; 2V </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
If we also wanted to include reactions involving pairs of different
populations, the model specification could easily run to many pages.
</p>

<p>
Happily, BEAST 2 provides a compact way to express repeated a
repeated fragment of XML: the <code>&lt;plate&gt;</code> element. To use this,
we surround a fragment of XML to repeat as follows:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">plate</span> <span class="org-nxml-attribute-local-name">var</span>=<span class="org-string">"i"</span> <span class="org-nxml-attribute-local-name">range</span>=<span class="org-string">"A,B,C,..."</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">fragment to repeat</span><span class="org-comment-delimiter"> --&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">plate</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
This causes the body of this element to be repeated a certain number of times,
defined by the number of comma-delimited values in the string passed to the <code>range</code> input.
The <code>var</code> input defines the name of a variable which will be substituted for each
of these values when it appears in the fragment.
</p>

<p>
Using <code>&lt;plate&gt;</code> notation, our model specification can be written much more simply as
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">plate</span> <span class="org-nxml-attribute-local-name">var</span>=<span class="org-string">"pop"</span> <span class="org-nxml-attribute-local-name">range</span>=<span class="org-string">"X,Y,Z,W,V"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"$(pop)"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> $(pop) -&gt; 2$(pop) </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">plate</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
We can also nest <code>&lt;plate&gt;</code> elements to create reactions involving multiple populations.
For instance, the following defines migration between each possible pair of populations:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">plate</span> <span class="org-nxml-attribute-local-name">var</span>=<span class="org-string">"source"</span> <span class="org-nxml-attribute-local-name">range</span>=<span class="org-string">"X,Y,Z,W,V"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">plate</span> <span class="org-nxml-attribute-local-name">var</span>=<span class="org-string">"dest"</span> <span class="org-nxml-attribute-local-name">range</span>=<span class="org-string">"X,Y,Z,W,V"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.5"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> $(source) -&gt; $(dest) </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">plate</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">plate</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
(Note that this will produce some reactions that do nothing, but this is not an issue.)
</p>

<p>
Besides a comma-delimited list of symbols, <code>range</code> can also take a
sequence notation "start:end" to represent a sequence of integers
between start and end inclusive.
This can be helpful in creating reactions involving many subpopulations:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">dimension</span>=<span class="org-string">"100"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">plate</span> <span class="org-nxml-attribute-local-name">var</span>=<span class="org-string">"i"</span> <span class="org-nxml-attribute-local-name">range</span>=<span class="org-string">"0:99"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X[$(i)] -&gt; 2X[$(i)] </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">plate</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-id-2-Birth-death-simulations-Trajectory-simulation" class="outline-3">
<h3 id="id-2-Birth-death-simulations-Trajectory-simulation"><span class="section-number-3">4.2.</span> Trajectory simulation</h3>
<div class="outline-text-3" id="text-id-2-Birth-death-simulations-Trajectory-simulation">
<p>
Trajectories are simply realisations of the population process.  There are two
distinct types of birth-death trajectories in ReMASTER:
<b>stochastic trajectories</b> and <b>deterministic trajectories</b>.
</p>

<p>
Stochastic trajectories are simulated using a standard Gillespie-style
algorithm, and are exact realisations of the continuous-time
discrete-state Markov process defined by the reactions.  These are the
trajectories that you'll want to use to simulate trees under
birth-death phylodynamic models.
</p>

<p>
Deterministic trajectories are simulated by integrating a set of
ordinary differential equations corresponding to the reactions.  The
dynamics generated are essentially the limiting behaviour of the
stochastic trajectories when the population sizes are very large and
the relative impact of the demographic stochasticity becomes
vanishingly small.  These are the trajectories you'll want to use to
simulate trees under coalescent approximations of
birth-death models.
</p>
</div>

<div id="outline-container-id-3-Trajectory-simulation-Birth-death-simulations-Stochastic-Trajectories" class="outline-4">
<h4 id="id-3-Trajectory-simulation-Birth-death-simulations-Stochastic-Trajectories"><span class="section-number-4">4.2.1.</span> Stochastic Trajectories</h4>
<div class="outline-text-4" id="text-id-3-Trajectory-simulation-Birth-death-simulations-Stochastic-Trajectories">
<p>
Once the population and reaction elements are specified, defining a
stochastic trajectory in ReMASTER's XML is very easy.
</p>

<p>
For example, the following represents a stochastic
birth-death-sampling process trajectory with constant rates:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectory"</span>
            <span class="org-nxml-attribute-local-name">maxTime</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.2"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 2X </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 0 </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
The <code>maxTime</code> attribute specifies the maximum end time of the
simulation.  For stochastic trajectories this attribute is actually
optional, since there are many birth-death processes (although not
this one) are guaranteed to terminate in finite amount of time.
(ReMASTER always ceases the simulation once no reactions are able to
fire.)
</p>
</div>
</div>

<div id="outline-container-id-3-Trajectory-simulation-Birth-death-simulations-Deterministic-Trajectories" class="outline-4">
<h4 id="id-3-Trajectory-simulation-Birth-death-simulations-Deterministic-Trajectories"><span class="section-number-4">4.2.2.</span> Deterministic Trajectories</h4>
<div class="outline-text-4" id="text-id-3-Trajectory-simulation-Birth-death-simulations-Deterministic-Trajectories">
<p>
Defining deterministic trajectories is almost exactly the same as defining
a stochastic trajectory.  The only difference is that the <code>spec</code> attribute
must be set to "DeterministicTrajectory" and the <code>maxTime</code> attribute is
mandatory.
</p>

<p>
For example, the following represents an exponentially growing population
with rate $\lambda-\mu=1.2-1.0=0.2$:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"DeterministicTrajectory"</span>
            <span class="org-nxml-attribute-local-name">maxTime</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.2"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 2X </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 0 </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
Another minor difference is that the <code>endsWhen</code> condition can only
include inequalities, since detecting equality in floating point
numbers can be problematic.
</p>

<p>
Finally, <code>DeterministicTrajectory</code> accepts two numerical attributes,
<code>forwardRelativeStepSize</code> and <code>backwardRelativeStepSize</code>.  These
attributes define the size of the steps taken by the forward-time and
backward-time numerical integrators, respectively, relative to the
total simulation time. Reducing the size of these values increases the
accuracy of the deterministic trajectory calculation and the
associated tree simulation, but makes the calculation more
computationally demanding.  The forward-time step size affects the
population size trajectory calculation accuracy, while the
backward-time step size affects only the subsequent tree simulation
accuracy.  Leaving these values to their default settings is usually
okay, but smaller step sizes may be necessary to avoid numerical
errors in certain situations. (These sometimes manifest in the form of
"too many lineages remaining" errors.) Models where populations are
changing very quickly are particularly susceptible to such problems.
</p>
</div>
</div>

<div id="outline-container-id-3-Trajectory-simulation-Birth-death-simulations-Placing-conditions-on-trajectories" class="outline-4">
<h4 id="id-3-Trajectory-simulation-Birth-death-simulations-Placing-conditions-on-trajectories"><span class="section-number-4">4.2.3.</span> Placing conditions on trajectories</h4>
<div class="outline-text-4" id="text-id-3-Trajectory-simulation-Birth-death-simulations-Placing-conditions-on-trajectories">
<p>
In addition to the rates and initial population sizes, conditions can
be placed on trajectory outcomes so that the simulation finishes
when the population sizes reach some specified target or, in the case
of stochastic trajectories, the resulting trajectory is only "accepted"
when a particular condition is met.
</p>

<p>
To define an early termination point, provide the <code>endsWhen</code> attribute
to the trajectory element.  The value of the attribute should be an expression
predicating which will cause the simulation to end when it becomes true.
For instance
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectory"</span>
            <span class="org-nxml-attribute-local-name">endsWhen</span>=<span class="org-string">"X=100"</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">...</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
defines a trajectory whose simulation will be terminated the instant that
the $X$ population contains exactly 100 individuals.
</p>

<p>
Similarly, to define a condition on the finished simulation, use the
<code>mustHave</code> attribute. For instance,
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectory"</span>
            <span class="org-nxml-attribute-local-name">mustHave</span>=<span class="org-string">"sample&gt;=50"</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">...</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
specifies that the  "sample" population must contain at least 50 individuals
at the end of the simulation.
</p>

<p>
The complete syntax for these predicates is specified in section <a href="#id-2-Appendix-Condition-syntax">8.1</a>.
Beware that XML (unfortunately) forbids use of characters such as <code>&lt;</code>
and <code>&amp;</code> in attribute values, so to use them you'll need to use the
escaped versions <code>&amp;lt;</code> and <code>&amp;amp;</code>.
</p>
</div>
</div>

<div id="outline-container-id-3-Trajectory-simulation-Birth-death-simulations-Self-contained-trajectory-simulation-XMLs" class="outline-4">
<h4 id="id-3-Trajectory-simulation-Birth-death-simulations-Self-contained-trajectory-simulation-XMLs"><span class="section-number-4">4.2.4.</span> Self-contained trajectory simulation XMLs</h4>
<div class="outline-text-4" id="text-id-3-Trajectory-simulation-Birth-death-simulations-Self-contained-trajectory-simulation-XMLs">
<p>
While the above XML fragments are sufficient to represent a simulated trajectory, in order to actually be useful
it needs to be embedded in a BEAST XML that produces output.  The most direct way to do this is via
ReMASTER's <code>Simulator</code> object, which can be used as a <code>&lt;run&gt;</code> element as follows:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">beast</span> <span class="org-nxml-attribute-local-name">version</span>=<span class="org-string">"2.0"</span> <span class="org-nxml-attribute-local-name">namespace</span>=<span class="org-string">"beast.base.inference:beast.base.inference.parameter:remaster"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">run</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Simulator"</span> <span class="org-nxml-attribute-local-name">nSims</span>=<span class="org-string">"100"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">simulate</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"trajectory"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectory"</span> <span class="org-nxml-attribute-local-name">maxTime</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.2"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 2X </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 0 </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">simulate</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"output.traj"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">idref</span>=<span class="org-string">"trajectory"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">run</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">beast</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
The <code>Simulator</code> takes the following inputs:
</p>
<dl class="org-dl">
<dt>nSims (required)</dt><dd>an integer specifying the number of independent simulations to perform,</dd>
<dt>simulate (required)</dt><dd>an object representing the simulation, in this case a <code>StochasticTrajectory</code>, and</dd>
<dt>logger</dt><dd>what to record in the output files for each replicate of the simulation.
This input can take multiple values, one for each output file.
(In this case we only produce one output file, containing a representation of the whole simulated trajectory.)</dd>
</dl>

<p>
To run the simulation and produce the output, copy the above XML into
a file named something like "BDtraj.xml" and then run it through
BEAST, either via the command line:
</p>
<pre class="example" id="org2d6de59">
$ beast BDtraj.xml
</pre>
<p>
or by running BEAST and selecting the "BDtraj.xml" file using the
graphical file choose which appears on startup.
</p>

<p>
This should produce some screen output, together with a file
"output.traj" in the same directory containing the simulated trajectories.
</p>
</div>
</div>

<div id="outline-container-id-3-Trajectory-simulation-Birth-death-simulations-Plotting-simulated-trajectories" class="outline-4">
<h4 id="id-3-Trajectory-simulation-Birth-death-simulations-Plotting-simulated-trajectories"><span class="section-number-4">4.2.5.</span> Plotting simulated trajectories</h4>
<div class="outline-text-4" id="text-id-3-Trajectory-simulation-Birth-death-simulations-Plotting-simulated-trajectories">
<p>
The "output.traj" file generated by the previous example is simply a
tab-separated-variable (TSV) file containing the size of the
population after each event in every replicate trajectory.  This file
be loaded directly into R for further analysis or for plotting.
</p>

<p>
From an R session in the same working directory as the simulation results,
use the following command to load the trajectories into a data frame:
</p>
<div class="org-src-container">
<pre class="src src-R">traj <span class="org-ess-assignment">&lt;-</span> read.table(<span class="org-string">"output.traj"</span>, header=T)
</pre>
</div>

<p>
Alternatively, the <code>read_tsv</code> command from the <code>readr</code> package (Tidyverse) can be used
to load the trajectories into a "tibble", which is often faster for large files:
</p>
<div class="org-src-container">
<pre class="src src-R"><span class="org-ess-modifiers">library</span>(readr)
traj <span class="org-ess-assignment">&lt;-</span> read_tsv(<span class="org-string">"output.traj"</span>)
</pre>
</div>

<p>
The resulting data frame has the following layout:
</p>
<pre class="example" id="org32f47a3">
&gt; traj
# A tibble: 7,605  5
   Sample     t population index value
    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;
 1      0 0     X              0     1
 2      0 0.117 X              0     0
 3      1 0     X              0     1
 4      1 2.60  X              0     2
 5      1 2.99  X              0     1
 6      1 3.17  X              0     0
 7      2 0     X              0     1
 8      2 0.583 X              0     2
 9      2 0.840 X              0     1
10      2 0.871 X              0     2
#  7,595 more rows
</pre>
<p>
Each row specifies the size of a particular population (or
subpopulation) at a particular time. The columns are as follows:
</p>
<dl class="org-dl">
<dt>Sample</dt><dd>A number which indicates to which specific simulated
trajectory the results belong.</dd>
<dt>t</dt><dd>The time with which the population size is associated.</dd>
<dt>population</dt><dd>The name (id) of the population.</dd>
<dt>index</dt><dd>An index starting at 0 indicating the subpopulation with
which the size is associated.  (This column will always be 0 if no
subpopulations are defined.)</dd>
<dt>value</dt><dd>The size of the population.</dd>
</dl>

<p>
This format is ideal for plotting using <a href="https://ggplot2.tidyverse.org">ggplot2</a>:
</p>
<div class="org-src-container">
<pre class="src src-R"><span class="org-ess-modifiers">library</span>(ggplot2)
ggplot(traj, aes(t, value, group_by=factor(Sample))) + geom_step(alpha=0.5)
</pre>
</div>
<p>
(The <code>group_by=factor(Sample)</code> ensures that population sizes associated with
different trajectories are grouped appropriately.)
</p>


<figure id="orga87adc0">
<img src="examples/BDtraj_output.png" alt="BDtraj_output.png">

</figure>

<p>
Replacing <code>StochasticTrajectory</code> with <code>DeterministicTrajectory</code> in the simulation XML
(and setting <code>nSims="1"</code>) produces an output file which, when plotted,
displays the following figure depicting the expected population size dynamics:
</p>


<figure id="orgb7ba27e">
<img src="examples/DetBDtraj_output.png" alt="DetBDtraj_output.png">

</figure>

<p>
(The deterministic model gives the true expected population size dynamics only for
linear models.)
</p>
</div>
</div>

<div id="outline-container-id-3-Trajectory-simulation-Birth-death-simulations-Logging-stochastic-trajectory-statistics" class="outline-4">
<h4 id="id-3-Trajectory-simulation-Birth-death-simulations-Logging-stochastic-trajectory-statistics"><span class="section-number-4">4.2.6.</span> Logging stochastic trajectory statistics</h4>
<div class="outline-text-4" id="text-id-3-Trajectory-simulation-Birth-death-simulations-Logging-stochastic-trajectory-statistics">
<p>
In addition to logging full trajectories, you can log basic statistics of simulated trajectories using
the <code>StochasticTrajectoryStatsLogger</code> logger, which can be added using an XML fragment like this:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"traj_stats.log"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectoryStatsLogger"</span> <span class="org-nxml-attribute-local-name">traj</span>=<span class="org-string">"@traj"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
This will write things like the total event count and the final population states to columns of the
output file.  Although all of this information is contained in the full trajectory log, occasionally
it is useful to log only a few basic statistics instead - the full trajectory logs can be very big.
</p>

<p>
(Additional statistics may be added to this logger in future.)
</p>
</div>
</div>
</div>

<div id="outline-container-id-2-Birth-death-simulations-Tree-simulation" class="outline-3">
<h3 id="id-2-Birth-death-simulations-Tree-simulation"><span class="section-number-3">4.3.</span> Tree simulation</h3>
<div class="outline-text-3" id="text-id-2-Birth-death-simulations-Tree-simulation">
<p>
Once a trajectory simulation is configured, producing the corresponding trees
is easy.  All that is required is to enclose the trajectory element
(<code>DeterministicTrajectory</code> or <code>StochasticTrajectory</code>) in a <code>SimulatedTree</code> element:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">tree</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"SimulatedTree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectory"</span>
              <span class="org-nxml-attribute-local-name">maxTime</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">samplePopulation</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"samp"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.4"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 2X </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.5"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 0 </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.5"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; samp </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">tree</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
The <code>SimulatedTree</code> object takes the following inputs
</p>
<dl class="org-dl">
<dt>trajectory (required)</dt><dd>a ReMASTER trajectory object.
For trajectories generated using <code>StochasticTrajectory</code>, trees are
exact realisations of the reconstructed phylogeny under the
corresponding branching process.  For trajectories generated using
<code>DeterministicTrajectory</code>, trees can be considered samples from a
diffusion approximation to the branching process.  (For details on this
kind of approximation, see <a href="https://doi.org/10.1534/genetics.111.134627">Volz et al., Genetics, 2012</a>.)</dd>

<dt>maxRetries (default 10)</dt><dd>This is the maximum number of times (default 10) that
the simulator should attempt to produce a tree, in the event that
the first simulated tree does not have exactly one root lineage.
(Simulated trees may have more than one root lineage in the instance
that not all sampled lineages find a common ancestor before the
start of the simulation; a situation common for deterministic
trajectories. It can also occur when the initial number of
individuals in the sampled population is greater than 1.)</dd>

<dt>removeSingletonNodes (default false)</dt><dd>This can be used to specify that single child nodes representing type changes
(if present) should be removed after the simulation is complete.
This is sometimes useful if the tree is to be used as the basis or
starting point for inference or sequence simulation, as not all BEAST 2 
classes know how to handle such nodes.</dd>
</dl>

<p>
Note: a <code>SimulatedTree</code> is a special case of the generic BEAST <code>Tree</code> object, and
can be used in BEAST 2 XML files wherever a <code>Tree</code> is expected. In this vein, if
a <code>TaxonSet</code> object is supplied to the optional <code>taxonset</code> input, the leaves of
the simulated tree can be associated with a pre-defined set of taxa.  This can
be useful when using <code>SimulatedTree</code> to initialise an MCMC analysis of an existing
data set, as demonstrated in the <a href="#orgda3df00">YuleInferenceInitialisation.xml</a> example.
</p>
</div>


<div id="outline-container-id-3-Tree-simulation-Birth-death-simulations-Self-contained-tree-simulation-XMLs" class="outline-4">
<h4 id="id-3-Tree-simulation-Birth-death-simulations-Self-contained-tree-simulation-XMLs"><span class="section-number-4">4.3.1.</span> Self-contained tree simulation XMLs</h4>
<div class="outline-text-4" id="text-id-3-Tree-simulation-Birth-death-simulations-Self-contained-tree-simulation-XMLs">
<p>
A self-contained tree simulation XML is very similar to a self-contained trajectory
simulation XML.  The only differences are that tree simulation XMLs have a <code>SimulatedTree</code>
object for the <code>&lt;simulate&gt;</code> element, and generally have a logger which writes the
simulated trees to a file.
</p>

<p>
For example, here is a full XML description of a tree simulator which produces
trees sampled from a linear birth-death-sampling model and saves them to a file
named "output.trees":
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">beast</span> <span class="org-nxml-attribute-local-name">version</span>=<span class="org-string">"2.0"</span> <span class="org-nxml-attribute-local-name">namespace</span>=<span class="org-string">"beast.base.inference:beast.base.inference.parameter:remaster"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">run</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Simulator"</span> <span class="org-nxml-attribute-local-name">nSims</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">simulate</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"tree"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"SimulatedTree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"trajectory"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectory"</span> <span class="org-nxml-attribute-local-name">maxTime</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">samplePopulation</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"samp"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.4"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 2X </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.5"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 0 </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.5"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; samp </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">simulate</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"output.traj"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">idref</span>=<span class="org-string">"trajectory"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"output.trees"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">idref</span>=<span class="org-string">"tree"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">run</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">beast</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
Note that in this example we have left the trajectory logger in place,
so in fact this XML produces both <code>output.traj</code> and <code>output.tree</code>
files.
</p>

<p>
Loading the tree file in a phylogenetic tree viewer such as <a href="https://icytree.org">icytree</a>, 
<a href="http://tree.bio.ed.ac.uk/software/Figtree/">FigTree</a> or into R using <a href="https://bioconductor.org/packages/release/bioc/html/ggtree.html">ggtree</a> allows you to view the result:
</p>


<figure id="org95cffc0">
<img src="examples/BDtree_output.png" alt="BDtree_output.png">

</figure>
</div>
</div>

<div id="outline-container-id-3-Tree-simulation-Birth-death-simulations-Logging-typed-trees" class="outline-4">
<h4 id="id-3-Tree-simulation-Birth-death-simulations-Logging-typed-trees"><span class="section-number-4">4.3.2.</span> Logging typed trees</h4>
<div class="outline-text-4" id="text-id-3-Tree-simulation-Birth-death-simulations-Logging-typed-trees">
<p>
The example model in the previous section contained only one main population
type (besides the sample population).  However, many interesting models
involve multiple types and result in trees whose edges are associated with
different populations.  The standard BEAST tree logger used in the previous
example will not record this information in its output file.
</p>

<p>
In order to include this information so that it can be shown on the tree,
you'll need to use the <code>TypedTreeLogger</code> in place of the standard logger:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">beast</span> <span class="org-nxml-attribute-local-name">version</span>=<span class="org-string">"2.0"</span> <span class="org-nxml-attribute-local-name">namespace</span>=<span class="org-string">"beast.base.inference:beast.base.inference.parameter:remaster"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">run</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Simulator"</span> <span class="org-nxml-attribute-local-name">nSims</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">simulate</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"tree"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"SimulatedTree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"trajectory"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectory"</span> <span class="org-nxml-attribute-local-name">maxTime</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"Y"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">samplePopulation</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"samp"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1.4"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 2X </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; Y </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.5"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 0 </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.5"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> Y -&gt; samp </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">simulate</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"output.trees"</span> <span class="org-nxml-attribute-local-name">mode</span>=<span class="org-string">"tree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"TypedTreeLogger"</span> <span class="org-nxml-attribute-local-name">tree</span>=<span class="org-string">"@tree"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">run</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">beast</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
Loading the resulting tree file into <a href="https://icytree.org">icytree</a> and colouring the edges using
the "type" attribute produces a visualisation in which the tree edges are
labeled by their corresponding population types:
</p>


<figure id="org3d9552c">
<img src="examples/BD2type_output.png" alt="BD2type_output.png">

</figure>
</div>
</div>

<div id="outline-container-id-3-Tree-simulation-Birth-death-simulations-Logging-untyped-trees" class="outline-4">
<h4 id="id-3-Tree-simulation-Birth-death-simulations-Logging-untyped-trees"><span class="section-number-4">4.3.3.</span> Logging untyped trees</h4>
<div class="outline-text-4" id="text-id-3-Tree-simulation-Birth-death-simulations-Logging-untyped-trees">
<p>
Occasionally you really <b>do</b> want to log trees without any additional
type annotation.  With single-population models this can be achieved
as shown in <a href="#id-3-Tree-simulation-Birth-death-simulations-Self-contained-tree-simulation-XMLs">4.3.1</a>.  However,
multi-population models (or models with sub-populations) often produce
trees with internal nodes representing type changes.  These nodes will
appear in the output trees, even when the edge types are not recorded.
This can also produce problems when using ReMASTER <code>SimulatedTree</code> objects
to initialise standard BEAST MCMC analyses, as the extra nodes will not
be properly understood.
</p>

<p>
To log output trees with these nodes removed, use <code>TypedTreeLogger</code> as in the previous
section, but add the attribute <code>removeSingletonNodes="true"</code>. This
will produce a tree in which the internal degree 3 nodes (one parent
two children) are still annotated, but in which degree 2 nodes (one
parent one child) are removed.  Such trees are fully compatible with
the rest of BEAST.
</p>

<p>
Alternatively, as mentioned at the start of this section, one can add
the same attribute <code>removeSingletonNodes="true"</code> to the
<code>SimulatedTree</code> element, causing these nodes to be stripped from the
simulated tree itself.  One can then use the standard tree logger as
in <a href="#id-3-Tree-simulation-Birth-death-simulations-Self-contained-tree-simulation-XMLs">4.3.1</a>.  This allows one to use the
simulated tree directly to initialise an MCMC analysis or to simulate
sequences, but has the drawback that the original multi-type tree is
lost.
</p>
</div>
</div>

<div id="outline-container-id-3-Tree-simulation-Birth-death-simulations-Logging-trees-with-variable-numbers-of-leaves" class="outline-4">
<h4 id="id-3-Tree-simulation-Birth-death-simulations-Logging-trees-with-variable-numbers-of-leaves"><span class="section-number-4">4.3.4.</span> Logging trees with variable numbers of leaves</h4>
<div class="outline-text-4" id="text-id-3-Tree-simulation-Birth-death-simulations-Logging-trees-with-variable-numbers-of-leaves">
<p>
Many stochastic models produce trees containing a random number of
leaves. Ensembles of trees containing different numbers of leaves
are written to BEAST tree files can cause downstream problems, as
such files explicitly assume the number of leaves is the same for
all trees they contain.
</p>

<p>
To circumvent this problem, one can use  <code>TypedTreeLogger</code> as above
but with the attribute <code>noLabels="true"</code> added.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-id-1-Coalescent-simulations" class="outline-2">
<h2 id="id-1-Coalescent-simulations"><span class="section-number-2">5.</span> Coalescent simulations</h2>
<div class="outline-text-2" id="text-id-1-Coalescent-simulations">
<p>
While birth-death simulations (both exact and approximate) are the
prime focus of ReMASTER, it is also possible to perform a variety
of coalescent simulations.
</p>
</div>

<div id="outline-container-id-2-Coalescent-simulations-Model-specification" class="outline-3">
<h3 id="id-2-Coalescent-simulations-Model-specification"><span class="section-number-3">5.1.</span> Model specification</h3>
<div class="outline-text-3" id="text-id-2-Coalescent-simulations-Model-specification">
<p>
Like birth-death model specifications, coalescent model specifications
are composed of <code>&lt;population/&gt;</code> and <code>&lt;reaction/&gt;</code> elements.  However,
Coalescent model specification differs from the specification of
birth-death models in three important ways.
</p>

<p>
Firstly, time increases into the past and thus represents age before the "present".
</p>

<p>
Secondly, instead of allowing population dynamics to be a realisation
of a stochastic process, coalescent models operate under the
assumption that the effective population sizes and how they vary in time are
known at the outset. Pairs of tree lineages associated with these populations
coalesce at a rate $1/N_e(t)$ where $N_e(t)$ is the effective population size
at time $t$.  (Note that in ReMASTER and BEAST 2 in general,
"effective population size" is simply the inverse
pairwise coalescent rate, and therefore has units of "time".)
For this reason, <code>&lt;population/&gt;</code> elements are associated with BEAST 2 <code>PopulationFunction</code> objects
rather than regular <code>Function</code> objects. For instance, the following element
introduces a constant-size population with $N_e(t)=10$:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"pop"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ConstantPopulation"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
(Like population elements in birth-death models, these population
elements <i>must</i> be marked with an <code>id</code> attribute.)
</p>

<p>
Thirdly, <code>&lt;reaction/&gt;</code> elements are interpreted "backward in time" and
apply directly to sampled phylogenetic tree lineages.  Because of
this, there is no concept of a "sampled" population or lineage.  As
usual though, reactions can be either continuous or punctual.  They're
useful for two main things: creating new lineages (i.e. samples/tips)
and transitioning lineages between populations (e.g.  migration events
in structured coalescent models). For instance, the following punctual
reaction generates 10 lineages associated with the population "pop" at
time 0:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"10"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> 0 -&gt; pop </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
Alternatively,
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"100 0"</span> <span class="org-nxml-attribute-local-name">changeTimes</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> 0 -&gt; pop </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
generates leaves at a fixed rate between time 0 and time 1.
(Note that rate of leaf generation explicitly changes from 1 to 0 at
time 1 to avoid generating infinite numbers of leaves.) For the chosen rate,
an average of 100 leaves will be generated by this second reaction, as
it describes a simple Poisson process.
</p>
</div>

<div id="outline-container-id-3-Model-specification-Coalescent-simulations-Vector-valued-coalescent-Reaction-inputs" class="outline-4">
<h4 id="id-3-Model-specification-Coalescent-simulations-Vector-valued-coalescent-Reaction-inputs"><span class="section-number-4">5.1.1.</span> Vector-valued coalescent Reaction inputs</h4>
<div class="outline-text-4" id="text-id-3-Model-specification-Coalescent-simulations-Vector-valued-coalescent-Reaction-inputs">
<p>
As with all reactions, the <code>n</code>, <code>times</code>, <code>rate</code> and <code>changeTimes</code> inputs can be
given multiple values.  In the context of coalescent models, this is
useful for specifying large numbers of leaves at different times, or
for allowing lineage migration rates to change in a piecewise-constant
way.
</p>

<p>
For example,
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"5"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"0 1 2 3"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> 0 -&gt; pop </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
produces 5 tips at each of the times 0, 1, 2, and 3; i.e. 20 leaf nodes in total.
</p>
</div>
</div>

<div id="outline-container-id-3-Model-specification-Coalescent-simulations-Parents-and-children-in-coalescent-reactions" class="outline-4">
<h4 id="id-3-Model-specification-Coalescent-simulations-Parents-and-children-in-coalescent-reactions"><span class="section-number-4">5.1.2.</span> Parents and children in coalescent reactions</h4>
<div class="outline-text-4" id="text-id-3-Model-specification-Coalescent-simulations-Parents-and-children-in-coalescent-reactions">
<p>
Since coalescent reactions are applied to lineages backward in time, the
meaning of parents and children is reversed.
</p>

<p>
For instance, in reaction
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> S -&gt; L </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
<p>
(which might appear in a structured coalescent model)
applies to all lineages currently associated with the <code>S</code> population.  The
"parent" in this reaction is the product <code>L</code>, while the child is the reactant <code>S</code>.
</p>

<p>
Note that, despite the switch in direction, coalescent reactions
follow the same rules as birth-death reactions for assigning parents
to children.  The ":id" suffix can be applied to both reactant
and product to force a parent-child relationship where the default
assignment is not correct.
</p>
</div>
</div>
</div>

<div id="outline-container-id-2-Coalescent-simulations-Trajectory-simulation" class="outline-3">
<h3 id="id-2-Coalescent-simulations-Trajectory-simulation"><span class="section-number-3">5.2.</span> Trajectory simulation</h3>
<div class="outline-text-3" id="text-id-2-Coalescent-simulations-Trajectory-simulation">
<p>
While there's no real concept of a population-level trajectory simulation in the context
of a coalescent model that conditions on population dynamics, ReMASTER still 
requires that you wrap your coalescent model specification in a <code>CoalescentTrajectory</code>
object, which is analogous to the birth-death trajectory objects.
</p>

<p>
For example, the <code>CoalescentTrajectory</code> object in the following XML
represents a two-deme structured coalescent model in which one of the
populations is growing exponentially toward the present:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">beast</span> <span class="org-nxml-attribute-local-name">version</span>=<span class="org-string">"2.0"</span>
       <span class="org-nxml-attribute-local-name">namespace</span>=<span class="org-string">"beast.base.inference:beast.base.inference.parameter:remaster</span>
<span class="org-string">                  :beast.base.evolution.tree.coalescent"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">run</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Simulator"</span> <span class="org-nxml-attribute-local-name">nSims</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">simulate</span>  <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"traj"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"CoalescentTrajectory"</span> <span class="org-nxml-attribute-local-name">maxTrajLogAge</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"C"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ConstantPopulation"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"10.0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"E"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ExponentialGrowth"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"100.0"</span> <span class="org-nxml-attribute-local-name">growthRate</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.1"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> C -&gt; E </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>

      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"50"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">0 -&gt; C</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"50"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">0 -&gt; E</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">simulate</span> <span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"output.traj"</span> <span class="org-nxml-attribute-local-name">log</span>=<span class="org-string">"@traj"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">run</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">beast</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
<b>Important:</b> Note the addition of ":beast.base.evolution.tree.coalescent" to the
<code>namespace</code> attribute.  This is necessary to avoid errors due to BEAST not being
able to find the <code>ConstantPopulation</code> and <code>ExponentialGrowth</code> classes, which are
part of BEAST 2 itself, not ReMASTER.
</p>

<p>
When coalescent trajectories are logged, as in the above example, the
output is simply a set of regularly-spaced samples of the effective
population size on which the model is conditioned.  (The maximum time
recorded is fixed by the value of the optional <code>maxTrajLogAge</code>
attribute of <code>CoalescentTrajectory</code>, which here is set to 10. The sampling
frequency can be set using another optional attribute, <code>loggingGridSize</code>, but
defaults to 101 samples.)
</p>

<p>
For example, loading the trajectory file generated by the above XML into R and plotting
it yields:
</p>
<div class="org-src-container">
<pre class="src src-R">read_tsv(<span class="org-string">"output.traj"</span>) <span class="org-ess-XopX">%&gt;%</span> ggplot(aes(t, value, col=population)) + geom_line()
</pre>
</div>


<figure id="org7842bce">
<img src="examples/Ctraj_output.png" alt="Ctraj_output.png">

</figure>

<p>
Because the population size dynamics are fixed, reactions described by
<code>&lt;reaction&gt;</code> elements have no effect on this output.
</p>
</div>
</div>

<div id="outline-container-id-2-Coalescent-simulations-Tree-simulation" class="outline-3">
<h3 id="id-2-Coalescent-simulations-Tree-simulation"><span class="section-number-3">5.3.</span> Tree simulation</h3>
<div class="outline-text-3" id="text-id-2-Coalescent-simulations-Tree-simulation">
<p>
As for birth-death models, we can simulate trees by wrapping the <code>CoalescentTrajectory</code>
object in a <code>SimulatedTree</code>:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">beast</span> <span class="org-nxml-attribute-local-name">version</span>=<span class="org-string">"2.0"</span>
       <span class="org-nxml-attribute-local-name">namespace</span>=<span class="org-string">"beast.base.inference:beast.base.inference.parameter:remaster</span>
<span class="org-string">                  :beast.base.evolution.tree.coalescent"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">run</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Simulator"</span> <span class="org-nxml-attribute-local-name">nSims</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">simulate</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"tree"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"SimulatedTree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span>  <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"traj"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"CoalescentTrajectory"</span> <span class="org-nxml-attribute-local-name">maxTrajLogAge</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"C"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ConstantPopulation"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"10.0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"E"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ExponentialGrowth"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"100.0"</span> <span class="org-nxml-attribute-local-name">growthRate</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"0.5"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> C -&gt; E </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>

        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"50"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">0 -&gt; C</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"50"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">0 -&gt; E</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">simulate</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"output.tree"</span> <span class="org-nxml-attribute-local-name">mode</span>=<span class="org-string">"tree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"TypedTreeLogger"</span> <span class="org-nxml-attribute-local-name">tree</span>=<span class="org-string">"@tree"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">run</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">beast</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
In the generated tree we see how the continuous reaction enables
one-way migration from <code>C</code> to <code>E</code>, while the two punctual reactions
produce 50 tips in each of the two populations at time zero:
</p>


<figure id="orgf470600">
<img src="examples/Ctree_output.png" alt="Ctree_output.png">

</figure>
</div>
</div>

<div id="outline-container-id-2-Coalescent-simulations-More-complex-coalescent-models" class="outline-3">
<h3 id="id-2-Coalescent-simulations-More-complex-coalescent-models"><span class="section-number-3">5.4.</span> More complex coalescent models</h3>
<div class="outline-text-3" id="text-id-2-Coalescent-simulations-More-complex-coalescent-models">
<p>
The kinds of population dynamics which can be expressed in ReMASTER is dictated
by the kinds of <code>PopulationFunction</code> classes which are available.  In BEAST itself,
only <code>ConstantPopulation</code> and <code>ExponentialGrowth</code> are provided, which limits the
utility of the simulator.
</p>

<p>
One approach to producing more complex scenarios is to use the <code>CompoundPopulationModel</code>
class available in the <a href="https://tgvaughan.github.io/feast">feast</a> package to combine these BEAST's primitive population
models in piecewise fashion.
</p>

<p>
For instance, the following XML simulates trees under a population model with a
strong population bottleneck between times 5 and 5.1, and an eventual exponential
decline into the past (growth into the future):
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">beast</span> <span class="org-nxml-attribute-local-name">version</span>=<span class="org-string">"2.0"</span>
       <span class="org-nxml-attribute-local-name">namespace</span>=<span class="org-string">"beast.base.inference.parameter:remaster</span>
<span class="org-string">                  :beast.base.evolution.tree.coalescent</span>
<span class="org-string">                  :feast.popmodels"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">run</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Simulator"</span> <span class="org-nxml-attribute-local-name">nSims</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">simulate</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"tree"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"SimulatedTree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"traj"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"CoalescentTrajectory"</span>
                  <span class="org-nxml-attribute-local-name">maxTrajLogAge</span>=<span class="org-string">"10"</span> <span class="org-nxml-attribute-local-name">trajLogSampleCount</span>=<span class="org-string">"1000"</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"pop"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"CompoundPopulationModel"</span> <span class="org-nxml-attribute-local-name">changeTimes</span>=<span class="org-string">"2.0 2.2 3.0"</span><span class="org-nxml-tag-delimiter">&gt;</span>
          <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">populationModel</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ConstantPopulation"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"100.0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
          <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">populationModel</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ConstantPopulation"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
          <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">populationModel</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ConstantPopulation"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"100.0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
          <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">populationModel</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ExponentialGrowth"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"100.0"</span> <span class="org-nxml-attribute-local-name">growthRate</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">population</span><span class="org-nxml-tag-delimiter">&gt;</span>

        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"100"</span> <span class="org-nxml-attribute-local-name">times</span>=<span class="org-string">"0"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">0 -&gt; pop</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>

      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">simulate</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"output.trees"</span> <span class="org-nxml-attribute-local-name">mode</span>=<span class="org-string">"tree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"TypedTreeLogger"</span> <span class="org-nxml-attribute-local-name">tree</span>=<span class="org-string">"@tree"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"output.traj"</span> <span class="org-nxml-attribute-local-name">log</span>=<span class="org-string">"@traj"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">run</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">beast</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
Plotting the trajectory yields a visualisation of the compound model:
</p>
<div class="org-src-container">
<pre class="src src-R">read_tsv(<span class="org-string">"output.traj"</span>) <span class="org-ess-XopX">%&gt;%</span> ggplot(aes(t,value,col=population)) + geom_line()
</pre>
</div>

<figure id="orgb7c12d6">
<img src="examples/ComplexCoalescent_traj.png" alt="ComplexCoalescent_traj.png">

</figure>

<p>
The following is an example output tree:
<img src="examples/ComplexCoalescent_tree.png" alt="ComplexCoalescent_tree.png">
</p>

<p>
Keep in mind that complex coalescent scenarios are sometimes better
treated using the diffusion-limit birth-death approximation framework
provided by <code>DeterministicTrajectory</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-id-1-Integrating-with-BEAST" class="outline-2">
<h2 id="id-1-Integrating-with-BEAST"><span class="section-number-2">6.</span> Integrating with BEAST</h2>
<div class="outline-text-2" id="text-id-1-Integrating-with-BEAST">
<p>
Unlike MASTER, ReMASTER is tightly integrated with the rest of BEAST in the following ways:
</p>

<ul class="org-ul">
<li>trees are standard BEAST <code>Tree</code> objects,</li>
<li>it uses standard <code>Logger</code> objects to produce output,</li>
<li>it uses <code>RealParameter</code> or <code>Function</code> objects to define birth-death populations,</li>
<li>it uses <code>PopulationFunction</code> objects to define coalescent populations,</li>
<li>the inputs defining reaction rates, times, probabilities or numbers
expect generic <code>Function</code> inputs.</li>
</ul>

<p>
This means that it is possible to use ReMASTER to initialise MCMC chains, to
simulate sequence data, or to produce single-XML simulation studies which combine
both simulation and inference.
</p>

<p>
Furthermore, the copious use of <code>Function</code> input types means that one can use
the <code>Function</code>-specific objects from the <a href="https://tgvaughan.github.io/feast">feast</a> package to create simulation XMLs
in which parameters are transformed in moderately complex ways before being
applied to the simulation.
</p>

<p>
For instance, suppose one wishes to simulate a trajectory under an
epidemiological model defined by a basic reproductive number
$R=\lambda/\mu$ instead of a birth rate.  One can easily do this as
follows:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">beast</span> <span class="org-nxml-attribute-local-name">version</span>=<span class="org-string">"2.0"</span> <span class="org-nxml-attribute-local-name">namespace</span>=<span class="org-string">"beast.base.inference:remaster"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">param</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"R"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1.5"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">param</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"mu"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>

  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">param</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"lambda"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"feast.expressions.ExpCalculator"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"R*mu"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">arg</span> <span class="org-nxml-attribute-local-name">idref</span>=<span class="org-string">"R"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">arg</span> <span class="org-nxml-attribute-local-name">idref</span>=<span class="org-string">"mu"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">param</span><span class="org-nxml-tag-delimiter">&gt;</span>

  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">run</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Simulator"</span> <span class="org-nxml-attribute-local-name">nSims</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">simulate</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"trajectory"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"StochasticTrajectory"</span> <span class="org-nxml-attribute-local-name">maxTime</span>=<span class="org-string">"10"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"X"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"RealParameter"</span> <span class="org-nxml-attribute-local-name">value</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"@lambda"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 2X </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Reaction"</span> <span class="org-nxml-attribute-local-name">rate</span>=<span class="org-string">"@mu"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text"> X -&gt; 0 </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">simulate</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"output.traj"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">idref</span>=<span class="org-string">"trajectory"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">run</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">beast</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
Alternatively, suppose you wish to simulate coalescent trees having
200 leaves evenly spaced over a period of 0.5 time units.  This can be
done by supplying a <code>feast.function.Sequence</code> object (feast
documentation <a href="https://tgvaughan.github.io/feast/#id-3-Numeric-sequences-as-Functions">here</a>), which generates a <code>Function</code> representing a
sequence of evenly spaced numbers, to the <code>times</code> input of the
corresponding <code>PunctualReaction</code>:
</p>

<div class="org-src-container">
<pre class="src src-xml"> <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">beast</span> <span class="org-nxml-attribute-local-name">version</span>=<span class="org-string">"2.0"</span>
       <span class="org-nxml-attribute-local-name">namespace</span>=<span class="org-string">"beast.base.inference.parameter:remaster</span>
<span class="org-string">                  :beast.base.evolution.tree.coalescent"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">run</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"Simulator"</span> <span class="org-nxml-attribute-local-name">nSims</span>=<span class="org-string">"100"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">simulate</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"tree"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"SimulatedTree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">trajectory</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"traj"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"CoalescentTrajectory"</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">population</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"pop"</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"ConstantPopulation"</span> <span class="org-nxml-attribute-local-name">popSize</span>=<span class="org-string">"1.0"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
        <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">reaction</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"PunctualReaction"</span> <span class="org-nxml-attribute-local-name">n</span>=<span class="org-string">"1"</span><span class="org-nxml-tag-delimiter">&gt;</span>
          <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">times</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"feast.function.Sequence"</span> <span class="org-nxml-attribute-local-name">start</span>=<span class="org-string">"0"</span> <span class="org-nxml-attribute-local-name">stop</span>=<span class="org-string">"0.5"</span> <span class="org-nxml-attribute-local-name">length</span>=<span class="org-string">"200"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">          0 -&gt; pop</span>
<span class="org-nxml-text">        </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">reaction</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">trajectory</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">simulate</span><span class="org-nxml-tag-delimiter">&gt;</span>

    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">logger</span> <span class="org-nxml-attribute-local-name">fileName</span>=<span class="org-string">"$(filebase).trees"</span> <span class="org-nxml-attribute-local-name">mode</span>=<span class="org-string">"tree"</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">log</span> <span class="org-nxml-attribute-local-name">spec</span>=<span class="org-string">"TypedTreeLogger"</span> <span class="org-nxml-attribute-local-name">tree</span>=<span class="org-string">"@tree"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">logger</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">run</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">beast</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-id-1-Examples" class="outline-2">
<h2 id="id-1-Examples"><span class="section-number-2">7.</span> Examples</h2>
<div class="outline-text-2" id="text-id-1-Examples">
<p>
The <code>examples/</code> directory of the package repository contains a growing list of example
ReMASTER scripts.  These are installed alongside the package when you install it via BEAUti.
You can also access these example scripts directly via the GitHub repository for the
package: <a href="https://github.com/tgvaughan/remaster/tree/master/examples">https://github.com/tgvaughan/remaster/tree/master/examples</a>.
</p>

<p>
<b><b>Note</b></b>: Some of these examples also require the BEAST 2 package <a href="https://tgvaughan.github.io/feast"><code>feast</code></a> to be installed.
This can be installed directly using the package manager in BEAUti in the same way that
you installed ReMASTER.
</p>

<p>
Here is a list of the example scripts contained in that directory, together
with brief summaries of the simulations they perform:
</p>

<dl class="org-dl">
<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/BDcontemp.xml"><code>BDcontemp.xml</code></a></dt><dd>Simulates birth-death trajectories and trees conditioned on
having 5 contemporaneous samples at time 5, and 5 more at time 6.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/BDserial.xml"><code>BDserial.xml</code></a></dt><dd>Simulates birth-death-sampling trajectories and trees.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/Coalescent.xml"><code>Coalescent.xml</code></a></dt><dd>Simulates coalescent trees with 10 leaves under a constant
effective population size of 1.0.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/ComplexCoalescent.xml"><code>ComplexCoalescent.xml</code></a> (requires feast)</dt><dd>Simulates coalescent trees under a more complex (piecewise constant
and exponential) population model. Also writes .traj file
summarizing the deterministic population dynamics.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/HetCoalescent.xml"><code>HetCoalescent.xml</code></a> (requires feast)</dt><dd>Demonstrates simulation of heterochronus coalescent trees using three
distinct leaf sampling strategies: continuous leaf sampling over a
time interval, even distribution of leaf times over an interval,
and sampling of a fixed number of leaf times from a uniform distribution
over a particular interval.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/CoalescentInferenceTree.xml"><code>CoalescentInferenceTree.xml</code></a></dt><dd>Simple self-contained coalescent inference simulation study XML.
Uses ReMASTER to simulate a tree under a coalescent model with a
true constant population size of 2.0, then uses BEAST to infer the
population size from that tree.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/CoalescentInferenceAlignment.xml"><code>CoalescentInferenceAlignment.xml</code></a> (requires feast)</dt><dd>A more complex self-contained coalescent inference simulation study
XML.  Uses Remaster to simulate a tree under a coalescent model with
a true constant population size of 2.0.  Sequence evolution is then
simulated down the tree using the sequence simulator from the <a href="https://tgvaughan.github.io/feast">feast</a>
package under a Jukes-Cantor model with strict clock rate of 0.05
substitutions/site/time. Finally, the XML runs a BEAST MCMC analysis
to jointly infer the tree, clock rate and population size from the
simulated sequence data.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/StructuredCoalescent.xml"><code>StructuredCoalescent.xml</code></a></dt><dd>Simple 2-deme structured coalescent simulation with constant
population sizes and contemporaneously-sampled leaves.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/StructuredCoalescentExp.xml"><code>StructuredCoalescentExp.xml</code></a></dt><dd>Simple 2-deme structured coalescent simulation with one constant
and one exponentially growing population, having 1000
contemporaneously-sampled leaves.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/EpiBD.xml"><code>EpiBD.xml</code></a> (requires feast)</dt><dd>Simple birth-death-sampling simulation parameterized in terms of
epidemiological parameters: basic reproductive number (R0),
becoming-uninfectious rate and sampling proportion, as defined
in <a href="https://doi.org/10.1073/pnas.1207965110">Stadler et al., 2013</a>.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/SIR.xml"><code>SIR.xml</code></a></dt><dd>Simulates stochastic Susceptible-Infectious-Removed (SIR) trajectories.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/SIRdet.xml"><code>SIRdet.xml</code></a></dt><dd>Produces a trajectory file containing the numerically-integrated solution
to the deterministic SIR ODEs. (In this case, the ODEs are treated as
an approximation to the stochastic process.)
This example also demonstrates the use of an end condition to terminate
the numerical integration.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/SEIR_tree.xml"><code>SEIR_tree.xml</code></a></dt><dd>Simulates a tree under the stochastic
Susceptible-Exposed-Infectious-Removed (SEIR) model, under a continuous
sampling process which only activates after 5 time units.</dd>
</dl>


<dl class="org-dl">
<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/SEIRdet_tree.xml"><code>SEIRdet_tree.xml</code></a></dt><dd>Simulates a tree using a coalescent approximation to the stochastic
Susceptible-Exposed-Infectious-Removed (SEIR) model with an explicit
termination condition and punctual sampling reactions.</dd>

<dt><a href="https://github.com/tgvaughan/remaster/blob/master/examples/SimulatedBDAlignment.xml"><code>SimulatedBDAlignment.xml</code></a> (requires feast)</dt><dd>Simulates a tree under a birth-death-sampling model, then simulates
sequence evolution under a basic Jukes-Cantor substitution model to
produce a corresponding simulated alignment.</dd>

<dt><a id="orgda3df00"></a><a href="https://github.com/tgvaughan/remaster/blob/master/examples/YuleInferenceInitialisation.xml"><code>YuleInferenceInitialisation.xml</code></a></dt><dd>Demonstrates the use of a ReMASTER birth-death tree simulation to
initilise the state of an MCMC analysis of primate sequences.</dd>
</dl>
</div>
</div>

<div id="outline-container-id-1-Appendix" class="outline-2">
<h2 id="id-1-Appendix"><span class="section-number-2">8.</span> Appendix</h2>
<div class="outline-text-2" id="text-id-1-Appendix">
</div>

<div id="outline-container-id-2-Appendix-Condition-syntax" class="outline-3">
<h3 id="id-2-Appendix-Condition-syntax"><span class="section-number-3">8.1.</span> Condition syntax</h3>
<div class="outline-text-3" id="text-id-2-Appendix-Condition-syntax">
<p>
The expressions provided to <code>endsWhen</code> and <code>mustHave</code> conform to the following
grammar:
</p>

<pre class="example" id="org8609787">
expression :
  '(' expression ')'
  |   (SUM|MIN|MAX) '(' expression ')'
  |   expression ('*'|'/'|'%') expression
  |   expression ('+'|'-') expression
  |   expression ('=='|'!='|'&lt;'|'&gt;'|'&lt;='|'&gt;=') expression
  |   expression ('&amp;&amp;'|'||') expression
  |   POP_ID
  |   NUMBER
  ;
</pre>

<p>
Here SUM(), MIN() and MAX() are functions which take a population
vector and compute the sum, minimum, or maximum, respectively.
</p>

<p>
<code>POP_ID</code> is any population ID such as "X" or "I[0]".
</p>

<p>
Beware when assembling these instructions that XML rules must be
obeyed.  In particular, you must use XML entities for characters such
as &amp; and &gt;, so that instead of writing <code>"X&gt;2 &amp;&amp; Y&gt;10"</code> you must
instead write <code>"X&amp;gt;2 &amp;amp;&amp;amp; Y&amp;gt;10"</code>.
</p>

<p>
Relevant characters and their corresponding XML entities are as follows
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Character</th>
<th scope="col" class="org-left">Entity</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&gt;</td>
<td class="org-left">&amp;gt;</td>
</tr>

<tr>
<td class="org-left">&lt;</td>
<td class="org-left">&amp;lt;</td>
</tr>

<tr>
<td class="org-left">&amp;</td>
<td class="org-left">&amp;amp;</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Tim Vaughan</p>
<p class="date">Created: 2024-04-08 Mon 16:58</p>
</div>
</body>
</html>
